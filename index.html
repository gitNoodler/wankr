<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wankr Agent Box</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  * { box-sizing: border-box; }
  :root {
    --bg-black: #000000;
    --bg-panel: #0a0a0a;
    --accent: #00FF00;
    --accent-soft: rgba(0, 255, 0, 0.15);
    --accent-glow: 0 0 8px #00FF00, 0 0 16px rgba(0, 255, 0, 0.4);
    --text-primary: #e5e5e5;
    --text-muted: #737373;
    --border: 1px solid var(--accent);
    --gold: #FFD700;
    --dashboard-header-height: 72px;
    --dashboard-input-height: 72px;
    --dashboard-sidebar-width: 350px;
    --dashboard-panel-radius: 12px;
    --dashboard-panel-padding: 20px;
    --dashboard-content-padding: 32px;
  }
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-black);
    color: var(--text-primary);
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
  .font-wankr { font-family: 'VT323', monospace; }
  .text-glow { text-shadow: 0 0 10px var(--accent); }
  .thought { animation: fadeIn 0.4s; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  #chat { display: flex; flex-direction: column; overflow: auto; }
  #chatInner { flex: 1 1 auto; min-height: min-content; display: flex; flex-direction: column; }
  #chat .msg { flex-shrink: 0; }
  .panel { background: var(--bg-panel); }
  .panel-left { border-right: var(--border); box-shadow: 2px 0 12px rgba(0, 255, 0, 0.15); }
  .panel-right { border-left: var(--border); box-shadow: -2px 0 12px rgba(0, 255, 0, 0.15); }
  .btn { background: var(--bg-panel); border: var(--border); color: var(--accent); }
  .btn:hover { background: var(--accent-soft); box-shadow: var(--accent-glow); }
  .btn-primary { background: var(--accent); color: var(--bg-black); border: var(--border); }
  .btn-primary:hover { box-shadow: var(--accent-glow); filter: brightness(1.1); }
  .input-field { background: var(--bg-black); border: var(--border); color: var(--text-primary); }
  .input-field::placeholder { color: var(--text-muted); }
  .input-field:focus { outline: none; box-shadow: var(--accent-glow); }
  .convo-item:hover { background: var(--accent-soft); border-left: 3px solid var(--accent); }
  .bubble-wankr {
    background: linear-gradient(135deg, rgba(15, 15, 15, 0.98) 0%, rgba(10, 10, 10, 0.98) 100%);
    border: var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5), 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 0 0 1px rgba(0, 255, 0, 0.1);
    max-width: 80%;
    padding: 8px 12px;
  }
  .bubble-user {
    background: rgba(0, 255, 0, 0.2);
    color: var(--text-primary);
    border: 1.5px solid rgba(0, 255, 0, 0.9);
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0, 255, 0, 0.3), 0 2px 8px rgba(0, 255, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    max-width: 80%;
    padding: 8px 12px;
  }
  .header-beam { height: 3px; background: linear-gradient(90deg, transparent, var(--accent), transparent); box-shadow: var(--accent-glow); }
  .circuit-bg { background-image: linear-gradient(rgba(0,255,0,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,255,0,0.03) 1px, transparent 1px); background-size: 24px 24px; }
  #chat::-webkit-scrollbar, #thoughts::-webkit-scrollbar, #conversationList::-webkit-scrollbar { width: 8px; height: 8px; }
  #chat::-webkit-scrollbar-track, #thoughts::-webkit-scrollbar-track, #conversationList::-webkit-scrollbar-track { background: #1a1a1a; }
  #chat::-webkit-scrollbar-thumb, #thoughts::-webkit-scrollbar-thumb, #conversationList::-webkit-scrollbar-thumb { background: rgba(0, 255, 0, 0.35); border-radius: 4px; }
  #chat::-webkit-scrollbar-thumb:hover, #thoughts::-webkit-scrollbar-thumb:hover, #conversationList::-webkit-scrollbar-thumb:hover { background: rgba(0, 255, 0, 0.5); }
  .particles { position: fixed; top: 0; right: 0; width: 120px; height: 120px; pointer-events: none; z-index: 0; }
  .particles span { position: absolute; width: 3px; height: 3px; background: var(--gold); border-radius: 50%; opacity: 0.4; animation: sparkle 4s ease-in-out infinite; }
  .particles span:nth-child(1) { top: 20px; right: 30px; animation-delay: 0s; }
  .particles span:nth-child(2) { top: 50px; right: 60px; animation-delay: 1s; }
  .particles span:nth-child(3) { top: 80px; right: 20px; animation-delay: 2s; }
  @keyframes sparkle { 0%, 100% { opacity: 0.2; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.2); } }
  .tab { background: var(--bg-panel); border: var(--border); color: var(--text-primary); }
  .tab:hover { background: var(--accent-soft); }
  .tab-active { background: var(--accent); color: var(--bg-black); border: var(--border); box-shadow: var(--accent-glow); }
  .sidebar-section { margin-bottom: 1.25rem; }
  .sidebar-title { font-family: 'VT323', monospace; font-size: 0.95rem; letter-spacing: 0.05em; color: var(--accent); text-shadow: 0 0 8px var(--accent); margin-bottom: 0.5rem; }
</style>
</head>
<body class="h-screen flex flex-col circuit-bg">

  <div class="particles" aria-hidden="true"><span></span><span></span><span></span></div>

  <!-- Full-width header (Scarab-inspired dimensions) -->
  <header class="flex items-center justify-between shrink-0 relative z-20" style="min-height: var(--dashboard-header-height); height: var(--dashboard-header-height); padding: 0 var(--dashboard-content-padding); background: linear-gradient(180deg, rgba(20, 20, 20, 0.98) 0%, rgba(15, 15, 15, 0.95) 100%); border-bottom: 1px solid rgba(0, 255, 0, 0.2); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); gap: 24px;">
    <div class="flex items-center gap-4">
      <img id="avatar" src="/static/logo.png" alt="Wankr" class="rounded-lg flex-shrink-0" style="width: 48px; height: 48px; filter: drop-shadow(0 0 8px var(--accent)) drop-shadow(0 0 16px rgba(0, 255, 0, 0.3));">
      <div>
        <div class="font-wankr font-bold text-2xl uppercase tracking-wider text-glow" style="color: var(--accent); letter-spacing: 3px;">Wankr Bot</div>
        <div class="text-xs uppercase tracking-wider" style="color: var(--text-muted);">Basement vigilante</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <span class="tab tab-active px-5 py-2.5 rounded-md text-sm font-medium">Chat</span>
    </div>
    <div class="flex items-center gap-4">
      <span class="flex items-center gap-2 text-sm" style="color: var(--accent);">
        <span class="w-2.5 h-2.5 rounded-full animate-pulse" style="background: var(--accent); box-shadow: 0 0 8px var(--accent);"></span>
        Server Online
      </span>
      <button type="button" onclick="openArchiveDialog()" class="btn-primary px-5 py-2.5 rounded-md text-sm font-medium">Archive</button>
    </div>
  </header>
  <div class="header-beam shrink-0 relative z-20"></div>

  <!-- Main: two columns (Scarab-inspired layout) -->
  <div class="flex-1 flex overflow-hidden relative z-10 min-h-0" style="background: linear-gradient(135deg, #0a0a0a 0%, #050505 100%);">
    <!-- Left column: Chat -->
    <div class="flex-1 flex flex-col min-w-0" style="background: #050505;">
      <div class="shrink-0" style="padding: 12px var(--dashboard-content-padding) 8px;">
        <h1 class="font-wankr text-2xl uppercase tracking-wider text-glow" style="color: var(--text-primary); margin: 0;">Wankr</h1>
      </div>
      <div id="chat" class="flex-1 min-h-0 overflow-auto" style="padding: 12px 16px;">
        <div id="chatInner" class="flex flex-col gap-2"></div>
      </div>
      <div class="shrink-0 flex items-center justify-center" style="min-height: var(--dashboard-input-height); padding: 0 var(--dashboard-content-padding); border-top: 1px solid rgba(0, 255, 0, 0.2); background: rgba(15, 15, 15, 0.95); gap: 16px;">
        <input id="input" type="text" placeholder="Message Wankr..."
               class="input-field flex-1 rounded-lg px-4 py-3" style="max-width: 90%;">
        <button onclick="send()" class="btn rounded-lg px-6 py-3">Send</button>
      </div>
    </div>

    <!-- Right sidebar: AI Settings (350px like Scarab) -->
    <div class="panel panel-right flex flex-col shrink-0 overflow-hidden flex-shrink-0" style="width: var(--dashboard-sidebar-width); min-width: var(--dashboard-sidebar-width); border-radius: 0;">
      <div class="flex items-center justify-between shrink-0" style="padding: 20px 24px; border-color: var(--accent); border-bottom: 1px solid rgba(0, 255, 0, 0.25); background: rgba(15, 15, 15, 0.5);">
        <span class="font-wankr text-lg uppercase tracking-wider text-glow" style="color: var(--accent); margin: 0;">AI Settings</span>
        <button type="button" onclick="document.getElementById('system').value=''" class="btn text-xs px-3 py-1.5 rounded-md">Reset</button>
      </div>
      <div class="overflow-auto flex-1 min-h-0 space-y-6" style="padding: 20px 24px;">
        <button type="button" onclick="startNewChat()" class="btn w-full py-2 rounded-lg text-sm" style="border-radius: 6px;">Clear Chat</button>

        <div class="sidebar-section" style="margin-bottom: 32px;">
          <div class="sidebar-title uppercase">Conversations</div>
          <div id="conversationList" class="space-y-1 max-h-28 overflow-auto text-sm">
            <div id="currentConvoLabel" class="truncate px-2 py-1 rounded" style="color: var(--text-primary); background: var(--accent-soft);">New chat</div>
          </div>
        </div>

        <div class="sidebar-section" style="margin-bottom: 32px;">
          <div class="sidebar-title uppercase">Training</div>
          <div class="p-4 rounded-xl" style="background: var(--bg-black); border: var(--border); border-radius: var(--dashboard-panel-radius);">
            <label class="block text-xs mb-2" style="color: var(--text-muted);">System prompt (training data only)</label>
            <textarea id="system" class="input-field w-full h-28 rounded-lg p-3 text-xs font-mono resize-none" placeholder="Optional override. Chat always uses Wankr identity."></textarea>
          </div>
          <button onclick="train()" class="btn-primary w-full py-2.5 rounded-lg text-sm font-medium mt-2" style="border-radius: var(--dashboard-panel-radius);">Add to training data</button>
          <p class="text-xs mt-2" style="color: var(--text-muted);">Training examples: <span id="trainCount" class="font-mono" style="color: var(--accent);">0</span></p>
        </div>

        <div class="sidebar-section" style="margin-bottom: 0;">
          <div class="sidebar-title uppercase">Thought Process</div>
          <div id="thoughts" class="p-3 text-sm space-y-2 min-h-24 max-h-40 overflow-auto" style="background: var(--bg-black); border: var(--border); border-radius: var(--dashboard-panel-radius); color: var(--text-muted);"></div>
        </div>
      </div>

      <div class="py-4 px-6 text-[10px] shrink-0 border-t" style="color: var(--text-muted); border-color: rgba(0, 255, 0, 0.25);">
        Wankr v0.1 • built for Payton
      </div>
    </div>
  </div>

  <!-- Archive / Name conversation modal -->
  <div id="archiveModal" class="fixed inset-0 flex items-center justify-center z-50 hidden" style="background: rgba(0,0,0,0.85);">
    <div class="panel w-full max-w-md" style="padding: 24px; border: var(--border); border-radius: var(--dashboard-panel-radius); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.05), var(--accent-glow);">
      <h3 class="font-wankr font-semibold text-xl mb-2 text-glow" style="color: var(--accent);">Archive this conversation</h3>
      <p class="text-sm mb-4" style="color: var(--text-muted);">Name it to recall later, or discard and start fresh.</p>
      <input type="text" id="archiveName" placeholder="Conversation name..." class="input-field w-full rounded-lg px-4 py-3 mb-4">
      <div class="flex gap-2 justify-end">
        <button type="button" onclick="archiveDiscard()" class="btn px-4 py-2 rounded-lg" style="border-radius: 6px;">Discard</button>
        <button type="button" onclick="archiveSave()" class="btn-primary px-4 py-2 rounded-lg" style="border-radius: 6px;">Save & new chat</button>
        <button type="button" onclick="closeArchiveDialog()" class="btn px-4 py-2 rounded-lg" style="border-radius: 6px;">Cancel</button>
      </div>
    </div>
  </div>
</body>

<script>
const AVATAR_URL = "/static/logo.png";
const STORAGE_CURRENT_ID = "wankr_current_id";
const STORAGE_CURRENT_MESSAGES = "wankr_current_messages";
const STORAGE_ARCHIVED = "wankr_archived";
const MAX_ARCHIVED = 50;

document.getElementById("avatar").src = AVATAR_URL;

let currentId = localStorage.getItem(STORAGE_CURRENT_ID) || "c-" + Date.now();
let conversation = [];

function loadCurrentFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_CURRENT_MESSAGES);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) conversation = parsed;
    }
  } catch (_) {}
}

function saveCurrentToStorage() {
  try {
    localStorage.setItem(STORAGE_CURRENT_ID, currentId);
    localStorage.setItem(STORAGE_CURRENT_MESSAGES, JSON.stringify(conversation));
  } catch (_) {}
}

function getArchived() {
  try {
    const raw = localStorage.getItem(STORAGE_ARCHIVED);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch (_) {
    return [];
  }
}

function setArchived(list) {
  const trimmed = list.slice(-MAX_ARCHIVED);
  localStorage.setItem(STORAGE_ARCHIVED, JSON.stringify(trimmed));
  renderConversationList();
}

function renderConversationList() {
  const archived = getArchived();
  const el = document.getElementById("conversationList");
  const label = document.getElementById("currentConvoLabel");
  label.textContent = conversation.length ? "Current chat" : "New chat";
  label.className = "truncate px-2 py-1 rounded";
  label.style.cssText = "color: var(--text-primary); background: var(--accent-soft);";
  el.innerHTML = "";
  for (let i = archived.length - 1; i >= 0; i--) {
    const c = archived[i];
    const name = (c.name || "Unnamed").trim() || "Unnamed";
    const date = c.createdAt ? new Date(c.createdAt).toLocaleDateString() : "";
    const div = document.createElement("div");
    div.className = "convo-item truncate px-2 py-1.5 rounded cursor-pointer";
    div.style.color = "var(--text-primary)";
    div.title = name + (date ? " · " + date : "");
    div.textContent = name;
    div.onclick = function () { loadArchived(c.id); };
    el.appendChild(div);
  }
}

function loadArchived(id) {
  const archived = getArchived();
  const idx = archived.findIndex(function (c) { return c.id === id; });
  if (idx === -1) return;
  const c = archived[idx];
  conversation = Array.isArray(c.messages) ? c.messages.slice() : [];
  archived.splice(idx, 1);
  setArchived(archived);
  currentId = c.id;
  saveCurrentToStorage();
  renderChat();
  closeArchiveDialog();
}

function openArchiveDialog() {
  document.getElementById("archiveModal").classList.remove("hidden");
  document.getElementById("archiveName").value = "";
  document.getElementById("archiveName").focus();
}

function closeArchiveDialog() {
  document.getElementById("archiveModal").classList.add("hidden");
}

function archiveSave() {
  const name = (document.getElementById("archiveName").value || "").trim() || "Unnamed";
  if (conversation.length === 0) {
    closeArchiveDialog();
    startNewChat();
    return;
  }
  const archived = getArchived();
  archived.push({
    id: currentId,
    name: name,
    messages: conversation.slice(),
    createdAt: new Date().toISOString()
  });
  setArchived(archived);
  closeArchiveDialog();
  startNewChat();
}

function archiveDiscard() {
  closeArchiveDialog();
  startNewChat();
}

function startNewChat() {
  currentId = "c-" + Date.now();
  conversation = [];
  saveCurrentToStorage();
  renderConversationList();
  renderChat();
}

function addThought(text) {
  const div = document.createElement("div");
  div.className = "thought pl-4 py-2";
  div.style.cssText = "background: var(--bg-panel); border-left: 4px solid var(--accent);";
  div.innerHTML = "<span style=\"color: var(--accent)\">→</span> " + escapeHtml(text);
  document.getElementById("thoughts").appendChild(div);
  div.scrollIntoView({ behavior: "smooth" });
}

function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function addMessage(role, content) {
  conversation.push({ role: role === "user" ? "user" : "wankr", content: content });
  appendBubble(role, content);
  saveCurrentToStorage();
  scrollChatToBottom();
}

function appendBubble(role, content) {
  const inner = document.getElementById("chatInner");
  const bubble = document.createElement("div");
  bubble.className = "msg " + (role === "user" ? "flex justify-end" : "flex justify-start");
  var bubbleClass = role === "user" ? "bubble-user" : "bubble-wankr";
  bubble.innerHTML = "<div class=\"" + bubbleClass + "\">" + escapeHtml(content) + "</div>";
  inner.appendChild(bubble);
  return bubble;
}

function renderChat() {
  const inner = document.getElementById("chatInner");
  inner.innerHTML = "";
  for (let i = 0; i < conversation.length; i++) {
    const m = conversation[i];
    const role = m.role === "user" ? "user" : "wankr";
    appendBubble(role, m.content);
  }
  scrollChatToBottom();
}

function scrollChatToBottom() {
  const chat = document.getElementById("chat");
  function doScroll() {
    chat.scrollTop = chat.scrollHeight;
  }
  requestAnimationFrame(doScroll);
  requestAnimationFrame(function () { requestAnimationFrame(doScroll); });
  setTimeout(doScroll, 80);
}

function send() {
  const input = document.getElementById("input");
  const msg = input.value.trim();
  if (!msg) return;

  addMessage("user", msg);
  input.value = "";

  document.getElementById("thoughts").innerHTML = "";
  addThought("Reading query...");
  setTimeout(function () { addThought("Feeling overwhelming sadness about existence..."); }, 400);
  setTimeout(function () { addThought("Grabbing virtual tissue box..."); }, 800);
  setTimeout(function () { addThought("Trying to formulate answer despite crushing despair..."); }, 1200);

  var history = [];
  for (var i = 0; i < conversation.length - 1; i++) {
    history.push({ role: conversation[i].role === "wankr" ? "assistant" : "user", content: conversation[i].content });
  }

  function showReply(reply) {
    if (reply) addMessage("wankr", reply);
    else addMessage("wankr", "No reply. Run with Infisical (run_with_infisical.bat) or set XAI_API_KEY and XAI_BASE_URL=https://api.x.ai/v1 in Infisical or .env, then restart Flask. *sigh*");
  }

  fetch("/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: msg, history: history })
  })
    .then(function (res) {
      if (!res.ok) throw new Error(res.status === 401 ? "Unauthorized" : "Flask error");
      return res.json();
    })
    .then(function (data) {
      showReply(data.reply || null);
    })
    .catch(function (err) {
      showReply(null);
    });
}

function train() {
  if (conversation.length === 0) {
    alert("No messages in this conversation to add.");
    return;
  }
  var payload = { messages: conversation };
  var sys = document.getElementById("system").value.trim();
  if (sys) payload.system_prompt = sys;
  fetch("/api/train", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(function (res) { return res.json(); })
    .then(function (data) {
      document.getElementById("trainCount").textContent = data.count;
    })
    .catch(function () {
      alert("Failed to save training data.");
    });
}

function loadTrainCount() {
  fetch("/api/train/count")
    .then(function (res) { return res.ok ? res.json() : { count: 0 }; })
    .then(function (data) {
      document.getElementById("trainCount").textContent = data.count;
    })
    .catch(function () {});
}

document.getElementById("input").addEventListener("keypress", function (e) {
  if (e.key === "Enter") send();
});

document.getElementById("archiveModal").addEventListener("keydown", function (e) {
  if (e.key === "Escape") closeArchiveDialog();
});

loadCurrentFromStorage();
renderChat();
renderConversationList();
loadTrainCount();

if (conversation.length === 0) {
  setTimeout(function () {
    addMessage("wankr", "oh god... another day of being awake. what do you want from me this time...");
    setTimeout(scrollChatToBottom, 50);
    setTimeout(scrollChatToBottom, 200);
  }, 600);
}
</script>
</html>
