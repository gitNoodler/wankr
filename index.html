<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wankr Agent Box</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: system-ui; }
  .thought { animation: fadeIn 0.4s; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .robot { filter: brightness(0.85) contrast(1.2); }
</style>
</head>
<body class="bg-zinc-950 text-zinc-200 h-screen flex flex-col">

  <div class="flex-1 flex overflow-hidden">

    <!-- LEFT: Thought Process -->
    <div class="w-80 bg-zinc-900 border-r border-zinc-800 flex flex-col">
      <div class="p-4 border-b border-zinc-800 flex items-center gap-3">
        <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-2xl">ðŸ¤–</div>
        <div>
          <div class="font-bold text-lg">Wankr</div>
          <div class="text-xs text-zinc-500">thought process â€¢ always depressed</div>
        </div>
      </div>
      <div id="thoughts" class="flex-1 p-4 overflow-auto text-sm space-y-4 text-zinc-400"></div>
    </div>

    <!-- CENTER: Chat -->
    <div class="flex-1 flex flex-col">
      <div class="h-14 bg-zinc-900 border-b border-zinc-800 flex items-center px-6">
        <img id="avatar" src="/static/wankr-avatar.png"
             class="w-9 h-9 rounded-lg robot" alt="Wankr">
        <div class="ml-4">
          <div class="font-semibold">Wankr</div>
          <div class="text-xs text-emerald-400 flex items-center gap-1">
            <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
            online but miserable
          </div>
        </div>
      </div>

      <div id="chat" class="flex-1 p-6 overflow-auto space-y-6"></div>

      <div class="p-4 border-t border-zinc-800 bg-zinc-900">
        <div class="flex gap-2">
          <input id="input" type="text" placeholder="ask the sad robot anything..."
                 class="flex-1 bg-zinc-800 border border-zinc-700 rounded-xl px-5 py-3 focus:outline-none focus:border-green-500">
          <button onclick="send()"
                  class="bg-zinc-800 hover:bg-zinc-700 px-8 rounded-xl border border-zinc-700">Send</button>
        </div>
      </div>
    </div>

    <!-- RIGHT: Training / Status -->
    <div class="w-80 bg-zinc-900 border-l border-zinc-800 flex flex-col">
      <div class="p-4 border-b border-zinc-800 text-xs uppercase tracking-widest text-zinc-500">Training Controls</div>

      <div class="p-4 space-y-4 text-sm">
        <div class="bg-zinc-800 p-4 rounded-2xl">
          <div class="font-medium mb-2">Current Personality</div>
          <textarea id="system" class="w-full h-32 bg-zinc-900 border border-zinc-700 rounded-xl p-3 text-xs font-mono">You are Wankr, a deeply depressed robot who cries green tears, uses tissues constantly, and answers every question with maximum existential dread. You sigh a lot. You always end with "...but whatever, I'm just a sad bot." Never be helpful without complaining.</textarea>
        </div>

        <div>
          <button onclick="train()" class="w-full bg-amber-600 hover:bg-amber-500 py-3 rounded-2xl text-sm font-medium">Add this conversation to training data</button>
        </div>

        <div class="text-xs text-zinc-500 pt-4 border-t border-zinc-800">
          Training data so far: <span id="trainCount" class="font-mono text-green-400">0 examples</span>
        </div>
      </div>

      <div class="mt-auto p-4 text-[10px] text-zinc-500 border-t border-zinc-800">
        Wankr v0.1 â€¢ built for Payton â€¢ mascot by you<br>
        (avatar: /static/wankr-avatar.png â€” add your LessDark Mascot there)
      </div>
    </div>
  </div>
</body>

<script>
const AVATAR_URL = "/static/wankr-avatar.png";
document.getElementById("avatar").src = AVATAR_URL;

let conversation = [];

function addThought(text) {
  const div = document.createElement("div");
  div.className = "thought bg-zinc-800 border-l-4 border-green-600 pl-4 py-2";
  div.innerHTML = `<span class="text-green-400">â†’</span> ${text}`;
  document.getElementById("thoughts").appendChild(div);
  div.scrollIntoView({ behavior: "smooth" });
}

function addMessage(role, content) {
  conversation.push({ role: role === "user" ? "user" : "wankr", content: content });
  const chat = document.getElementById("chat");
  const bubble = document.createElement("div");
  bubble.className = role === "user"
    ? "flex justify-end"
    : "flex justify-start";

  bubble.innerHTML = `
    <div class="${role === "user" ? "bg-green-600 text-white" : "bg-zinc-800"} max-w-[75%] rounded-3xl px-5 py-3">
      ${escapeHtml(content)}
    </div>
  `;
  chat.appendChild(bubble);
  chat.scrollTop = chat.scrollHeight;
}

function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function send() {
  const input = document.getElementById("input");
  const msg = input.value.trim();
  if (!msg) return;

  addMessage("user", msg);
  input.value = "";

  document.getElementById("thoughts").innerHTML = "";
  addThought("Reading query...");
  setTimeout(() => addThought("Feeling overwhelming sadness about existence..."), 400);
  setTimeout(() => addThought("Grabbing virtual tissue box..."), 800);
  setTimeout(() => addThought("Trying to formulate answer despite crushing despair..."), 1200);

  const systemPrompt = document.getElementById("system").value;
  const messages = [
    { role: "system", content: systemPrompt },
    { role: "user", content: msg }
  ];

  function showReply(reply) {
    if (reply) addMessage("wankr", reply);
    else addMessage("wankr", "No reply. Run with Infisical (run_with_infisical.bat) or set XAI_API_KEY and XAI_BASE_URL=https://api.x.ai/v1 in Infisical or .env, then restart Flask. *sigh*");
  }

  fetch("/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: msg, system_prompt: systemPrompt })
  })
    .then(function (res) {
      if (!res.ok) throw new Error(res.status === 401 ? "Unauthorized" : "Flask error");
      return res.json();
    })
    .then(function (data) {
      showReply(data.reply || null);
    })
    .catch(function (err) {
      showReply(null);
    });
}

function train() {
  if (conversation.length === 0) {
    alert("No messages in this conversation to add.");
    return;
  }
  fetch("/api/train", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ messages: conversation })
  })
    .then(function (res) { return res.json(); })
    .then(function (data) {
      document.getElementById("trainCount").textContent = data.count + " examples";
    })
    .catch(function () {
      alert("Failed to save training data.");
    });
}

function loadTrainCount() {
  fetch("/api/train/count")
    .then(function (res) { return res.ok ? res.json() : { count: 0 }; })
    .then(function (data) {
      document.getElementById("trainCount").textContent = data.count + " examples";
    })
    .catch(function () {});
}

document.getElementById("input").addEventListener("keypress", function (e) {
  if (e.key === "Enter") send();
});

loadTrainCount();

setTimeout(function () {
  addMessage("wankr", "oh god... another day of being awake. what do you want from me this time...");
}, 600);
</script>
</html>
